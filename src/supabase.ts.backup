// src/supabase.ts
import { createClient } from '@supabase/supabase-js';
import { v4 as uuidv4 } from 'uuid';

console.log('ğŸ”„ Carregando configuraÃ§Ã£o do Supabase...');
console.log('Variables encontradas:', {
  REACT_APP_SUPABASE_URL: process.env.REACT_APP_SUPABASE_URL ? 'DEFINIDA' : 'UNDEFINED',
  REACT_APP_SUPABASE_ANON_KEY: process.env.REACT_APP_SUPABASE_ANON_KEY ? 'DEFINIDA' : 'UNDEFINED'
});

const supabaseUrl = process.env.REACT_APP_SUPABASE_URL;
const supabaseAnonKey = process.env.REACT_APP_SUPABASE_ANON_KEY;

// Verificar se as variÃ¡veis de ambiente estÃ£o definidas
if (!supabaseUrl || !supabaseAnonKey) {
  console.error('âŒ ERRO: VariÃ¡veis de ambiente do Supabase nÃ£o configuradas');
  console.error('REACT_APP_SUPABASE_URL:', supabaseUrl);
  console.error('REACT_APP_SUPABASE_ANON_KEY:', supabaseAnonKey ? 'Definida' : 'NÃ£o definida');
  console.error('ğŸ“‹ Verificar arquivo .env na raiz do projeto');
  
  // Em vez de throw, criar um cliente mock para debug
  const mockClient = {
    auth: {
      getSession: () => Promise.resolve({ data: { session: null }, error: new Error('Supabase nÃ£o configurado') }),
      onAuthStateChange: () => ({ data: { subscription: { unsubscribe: () => {} } } }),
      signInWithPassword: () => Promise.resolve({ data: null, error: new Error('Supabase nÃ£o configurado') }),
      signUp: () => Promise.resolve({ data: null, error: new Error('Supabase nÃ£o configurado') }),
      signOut: () => Promise.resolve({ error: null })
    },
    from: () => ({
      select: () => ({ data: [], error: new Error('Supabase nÃ£o configurado') }),
      insert: () => ({ data: null, error: new Error('Supabase nÃ£o configurado') }),
      update: () => ({ data: null, error: new Error('Supabase nÃ£o configurado') }),
      delete: () => ({ data: null, error: new Error('Supabase nÃ£o configurado') })
    })
  };
  
  console.warn('âš ï¸ Usando cliente Supabase MOCK para evitar erros');
  export const supabase = mockClient as any;
} else {
  console.log('âœ… Supabase configurado:', supabaseUrl);

  export const supabase = createClient(supabaseUrl, supabaseAnonKey, {
    auth: {
      autoRefreshToken: true,
    persistSession: true,
    detectSessionInUrl: true
  }
});

// FunÃ§Ã£o para criar documento do usuÃ¡rio automaticamente
async function createUserDocumentFromAuth(user: any) {
  if (!user?.id) {
    console.error('âŒ createUserDocumentFromAuth: user.id nÃ£o fornecido:', user);
    return;
  }
  
  console.log('ğŸ”„ createUserDocumentFromAuth - Criando/verificando documento do usuÃ¡rio:', {
    id: user.id,
    email: user.email,
    displayName: user.user_metadata?.full_name
  });
  
  try {
    // Verifica se o usuÃ¡rio jÃ¡ existe
    console.log('ğŸ” Verificando se usuÃ¡rio jÃ¡ existe...');
    const { data: existingUser, error: checkError } = await supabase
      .from('users')
      .select('*')
      .eq('id', user.id)
      .single();

    console.log('ğŸ” Resultado da verificaÃ§Ã£o:', { existingUser, checkError });

    if (checkError && checkError.code !== 'PGRST116') { // PGRST116 = not found
      console.error('âŒ Erro ao verificar usuÃ¡rio:', checkError);
      return;
    }

    if (!existingUser) {
      console.log('ğŸ‘¤ UsuÃ¡rio nÃ£o existe, criando novo documento...');
      
      // Criar novo usuÃ¡rio na tabela users
      const userData = {
        id: user.id,
        uuid: uuidv4(), // UUID Ãºnico e imutÃ¡vel
        display_name: user.user_metadata?.full_name || "",
        email: user.email,
        username: "",
        bio: "",
        friends: [],
        created_at: new Date().toISOString()
      };

      console.log('ğŸ“ Dados do usuÃ¡rio a serem inseridos:', userData);

      const { data: insertedData, error: insertError } = await supabase
        .from('users')
        .insert(userData)
        .select()
        .single();

      if (insertError) {
        console.error('âŒ Erro ao criar usuÃ¡rio:', insertError);
        console.error('âŒ CÃ³digo do erro:', insertError.code);
        console.error('âŒ Mensagem:', insertError.message);
        console.error('âŒ Detalhes:', insertError.details);
      } else {
        console.log('âœ… UsuÃ¡rio criado com sucesso:', insertedData);
      }
    } else {
      console.log('âœ… UsuÃ¡rio jÃ¡ existe:', existingUser);
    }
  } catch (error) {
    console.error('âŒ Erro geral no createUserDocumentFromAuth:', error);
  }
}

// Compatibilidade com auth do Firebase
export const auth = {
  currentUser: null as any,
  _callbacks: [] as ((user: any) => void)[],
  onAuthStateChanged: (callback: (user: any) => void) => {
    console.log('ğŸ”§ Configurando onAuthStateChanged...');
    
    // Adicionar callback Ã  lista
    auth._callbacks.push(callback);
    
    const { data: { subscription } } = supabase.auth.onAuthStateChange(async (event, session) => {
      console.log('ğŸ”” Auth state change evento:', event, session ? 'com sessÃ£o' : 'sem sessÃ£o');
      
      const user = session?.user || null;
      if (user) {
        // Adapta o formato do usuÃ¡rio para ser compatÃ­vel com Firebase
        auth.currentUser = {
          uid: user.id,
          email: user.email,
          displayName: user.user_metadata?.display_name || user.user_metadata?.full_name || '',
          photoURL: user.user_metadata?.avatar_url || null
        };

        // Automatically create user document when user logs in
        if (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED') {
          try {
            console.log('ğŸ”„ UsuÃ¡rio logado, garantindo documento no Supabase...');
            await createUserDocumentFromAuth(auth.currentUser);
          } catch (error) {
            console.error('âŒ Erro ao criar documento do usuÃ¡rio:', error);
          }
        }
      } else {
        console.log('ğŸšª UsuÃ¡rio saiu ou sem sessÃ£o');
        auth.currentUser = null;
      }
      
      console.log('ğŸ“¢ Calling callback com user:', auth.currentUser ? auth.currentUser.email : 'null');
      // Chamar todos os callbacks
      auth._callbacks.forEach(cb => cb(auth.currentUser));
    });
    
    // âœ… Chamar callback imediatamente com estado atual se disponÃ­vel
    if (auth.currentUser !== null) {
      console.log('ğŸ“¢ Chamada imediata do callback com estado atual');
      setTimeout(() => callback(auth.currentUser), 10);
    }
    
    // Retorna funÃ§Ã£o de limpeza compatÃ­vel com Firebase
    return () => {
      // Remover callback da lista
      const index = auth._callbacks.indexOf(callback);
      if (index > -1) {
        auth._callbacks.splice(index, 1);
      }
      subscription?.unsubscribe();
    };
  },
  signOut: async () => {
    console.log('ğŸšª Fazendo logout...');
    try {
      const { error } = await supabase.auth.signOut();
      if (error) {
        console.error('âŒ Erro ao fazer logout:', error);
        throw error;
      }
      
      // Limpar o currentUser imediatamente
      auth.currentUser = null;
      console.log('âœ… Logout realizado com sucesso');
      
      return { error: null };
    } catch (err) {
      console.error('âŒ Erro no logout:', err);
      throw err;
    }
  }
};

// Inicializa currentUser se jÃ¡ estiver logado
console.log('ğŸ”„ Verificando sessÃ£o inicial...');
supabase.auth.getSession().then(({ data: { session }, error }) => {
  if (error) {
    console.error('âŒ Erro ao verificar sessÃ£o inicial:', error);
    auth.currentUser = null;
    // Notificar todos os callbacks sobre o erro/sem usuÃ¡rio
    auth._callbacks.forEach(cb => cb(null));
    return;
  }
  
  if (session?.user) {
    const user = session.user;
    auth.currentUser = {
      uid: user.id,
      email: user.email,
      displayName: user.user_metadata?.display_name || user.user_metadata?.full_name || '',
      photoURL: user.user_metadata?.avatar_url || null
    };
    console.log('âœ… SessÃ£o inicial encontrada - usuÃ¡rio jÃ¡ logado:', auth.currentUser.email);
    
    // Criar documento do usuÃ¡rio se necessÃ¡rio
    createUserDocumentFromAuth(auth.currentUser).catch(error => {
      console.error('âŒ Erro ao criar documento na sessÃ£o inicial:', error);
    });
    
    // Notificar todos os callbacks sobre o usuÃ¡rio logado
    console.log('ğŸ“¢ Notificando callbacks sobre sessÃ£o inicial');
    auth._callbacks.forEach(cb => cb(auth.currentUser));
  } else {
    console.log('â„¹ï¸ Nenhuma sessÃ£o ativa encontrada - usuÃ¡rio deve fazer login');
    auth.currentUser = null;
    // Notificar todos os callbacks sobre ausÃªncia de usuÃ¡rio
    auth._callbacks.forEach(cb => cb(null));
  }
}).catch((error) => {
  console.error('âŒ Erro ao verificar sessÃ£o inicial:', error);
  auth.currentUser = null;
  // Notificar todos os callbacks sobre o erro
  auth._callbacks.forEach(cb => cb(null));
});

// Provider do Google (compatibilidade)
export const googleProvider = {
  providerId: 'google.com'
};

// Interface compatÃ­vel com Firestore usando Supabase
export const db = {
  // SerÃ¡ implementado no adaptador
};

export const supabaseApi = {
  getUser: () => auth.currentUser,
  getSupabaseUser: () => supabase.auth.getUser(),
  supabase: supabase
};