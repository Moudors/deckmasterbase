// src/pages/CreateDeck.tsx
import React, { useState, useEffect } from "react";
import { useNavigate, useLocation } from "react-router-dom";
import { useQueryClient } from "@tanstack/react-query";
import { localDeckManager } from "@/lib/localDeckManager";
import { auth } from "@/supabase";
import { db } from "@/lib/firestoreAdapter";
import { useAuthState } from "@/hooks/useAuthState";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";

interface CardToAdd {
  card_name: string;
  scryfall_id: string;
  image_url: string;
  mana_cost?: string;
  type_line?: string;
  oracle_text?: string;
  card_faces?: any;
}

interface LocationState {
  cardToAdd?: CardToAdd;
}

function CreateDeck() {
  const navigate = useNavigate();
  const location = useLocation();
  const queryClient = useQueryClient();
  const [user] = useAuthState();
  const [deckName, setDeckName] = useState("");
  const [format, setFormat] = useState("");
  
  // ğŸ´ Carta para adicionar automaticamente apÃ³s criar o deck
  const cardToAdd = (location.state as LocationState)?.cardToAdd;

  // ğŸ¨ Helper para converter URL para art_crop (arte sem frame)
  const getArtCropUrl = (imageUrl: string | undefined) => {
    if (!imageUrl) return null;
    if (imageUrl.includes("/normal/")) {
      return imageUrl.replace("/normal/", "/art_crop/");
    }
    return imageUrl;
  };

  // ğŸ” Loga no console sempre que o formato mudar
  useEffect(() => {
    console.log("Formato atual:", format);
  }, [format]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!deckName || !format || !user) return;

    try {
      console.log("ğŸ”§ Criando deck LOCALMENTE (sem Firebase)...");
      
      // ğŸ¯ Cria o deck LOCALMENTE com ID real
      const deckId = await localDeckManager.saveDeckLocally({
        ownerId: user.id,
        name: deckName,
        format,
        cards: [],
        createdAt: new Date(),
        // ğŸ¨ Define a capa como art_crop (arte sem frame) da primeira carta
        cover_image_url: getArtCropUrl(cardToAdd?.image_url) || null,
        coverImage: getArtCropUrl(cardToAdd?.image_url) || null,
      });

      console.log("âœ… Deck criado LOCALMENTE com ID real:", deckId);
      console.log("ğŸ“¦ Deck serÃ¡ sincronizado quando houver quota disponÃ­vel");
      
      if (cardToAdd?.image_url) {
        console.log("ğŸ¨ Capa do deck definida:", cardToAdd.image_url);
      }

      // ğŸ”„ Invalida e forÃ§a refetch imediato da query dos decks
      await queryClient.invalidateQueries({ queryKey: ["decks", user.uid] });
      await queryClient.refetchQueries({ queryKey: ["decks", user.uid] });
      console.log("ğŸ”„ Cache atualizado - deck deve aparecer na Home");

      // ğŸ´ Se hÃ¡ uma carta para adicionar, redireciona com a carta no state
      if (cardToAdd && deckId) {
        console.log("ğŸ¯ Redirecionando para deck com carta:", cardToAdd.card_name);
        
        // Prepara os dados da carta no formato que o Deckbuilder espera
        const cardForDeckbuilder = {
          id: cardToAdd.scryfall_id,
          name: cardToAdd.card_name,
          image_uris: cardToAdd.image_url ? { normal: cardToAdd.image_url } : undefined,
          card_faces: cardToAdd.card_faces || undefined,
          mana_cost: cardToAdd.mana_cost || "",
          type_line: cardToAdd.type_line || "",
          oracle_text: cardToAdd.oracle_text || "",
        };
        
        console.log("ğŸ“¤ Dados enviados para Deckbuilder:", cardForDeckbuilder);
        
        // Redireciona para o Deckbuilder com a carta no state
        navigate(`/deckbuilder/${deckId}`, {
          state: {
            addCard: cardForDeckbuilder,
            _localDeck: true, // Indica que Ã© deck local
          }
        });
      } else {
        // Se nÃ£o hÃ¡ carta, apenas navega para o deck vazio
        navigate(`/deckbuilder/${deckId}`, {
          state: { _localDeck: true }
        });
      }
    } catch (error) {
      console.error("âŒ Erro ao criar deck:", error);
      alert("Erro ao criar deck. Tente novamente.");
    }
  };

  return (
    <div className="h-screen w-screen bg-gradient-to-br from-gray-900 to-black text-white flex flex-col">
      {/* Header */}
      <div className="flex items-center gap-2 p-4">
        <button
          onClick={() => navigate(-1)}
          className="text-orange-500 hover:text-orange-400"
        >
          â† Voltar
        </button>
      </div>

      <div className="flex flex-col items-center text-center px-6">
        <h1 className="text-2xl font-bold">Criar Novo Deck</h1>
        <p className="text-gray-400 mt-1">
          Preencha as informaÃ§Ãµes do seu deck
        </p>
        
        {/* ğŸ´ Indicador de carta para adicionar */}
        {cardToAdd && (
          <div className="mt-4 bg-orange-500/20 border border-orange-500 rounded-lg px-4 py-2">
            <p className="text-sm text-orange-300">
              ğŸ´ A carta <span className="font-bold">{cardToAdd.card_name}</span> serÃ¡ adicionada ao deck
            </p>
          </div>
        )}
      </div>

      {/* FormulÃ¡rio */}
      <form
        onSubmit={handleSubmit}
        className="flex flex-col gap-6 px-6 mt-8"
      >
        {/* Nome do Deck */}
        <div className="flex flex-col gap-2">
          <label className="text-sm text-gray-300">Nome do Deck</label>
          <input
            type="text"
            value={deckName}
            onChange={(e) => setDeckName(e.target.value)}
            placeholder="Ex: DragÃµes Vermelhos"
            className="rounded-md border border-gray-700 bg-gray-800 px-3 py-2 text-white focus:border-orange-500 focus:outline-none"
          />
        </div>

        {/* Formato */}
        <div className="flex flex-col gap-2">
          <label className="text-sm text-gray-300">Formato</label>
          <Select value={format} onValueChange={setFormat}>
            <SelectTrigger className="w-full rounded-md border border-gray-700 bg-gray-800 px-3 py-2 text-white focus:border-orange-500 focus:outline-none">
              <SelectValue placeholder="Selecione o formato" />
            </SelectTrigger>
            <SelectContent className="bg-gray-800 text-white border border-gray-700">
              <SelectItem value="Commander">Commander</SelectItem>
              <SelectItem value="Commander 300">Commander 300</SelectItem>
              <SelectItem value="Commander 500">Commander 500</SelectItem>
              <SelectItem value="Standard">Standard</SelectItem>
              <SelectItem value="Modern">Modern</SelectItem>
              <SelectItem value="Pioneer">Pioneer</SelectItem>
              <SelectItem value="Pauper">Pauper</SelectItem>
              <SelectItem value="Legacy">Legacy</SelectItem>
            </SelectContent>
          </Select>
        </div>

        {/* BotÃ£o AvanÃ§ar */}
        <button
          type="submit"
          className="mt-6 flex items-center justify-center gap-2 rounded-md bg-orange-500 px-4 py-2 font-semibold text-white hover:bg-orange-600"
        >
          AvanÃ§ar â†’
        </button>
      </form>
    </div>
  );
}

export default CreateDeck;
